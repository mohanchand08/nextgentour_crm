<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nextgen Tours CRM Quotation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Icon library for quick access to role icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment - ATTACHED TO WINDOW
        
        // Use environment variables if available to match the token issuer for security
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'nextgentour_crm'; 
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            // Fallback config - REPLACE THESE WITH YOUR OWN NETLIFY/FIREBASE KEYS IF DEPLOYING
            apiKey: "AIzaSyDsT_0sWr56iKMs8qz4JUSzlzFPLaXQfhY",
            authDomain: "nextgentours-crm-test.firebaseapp.com",
            projectId: "nextgentours-crm-test",
            storageBucket: "nextgentours-crm-test.firebasestorage.app",
            messagingSenderId: "683064898014",
            appId: "1:683064898014:web:53dc45de994177bc256d4f",
            measurementId: "G-K3MYQZ21PH"
        }));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);

            setLogLevel('Debug');

            // Authentication and Initialization
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.userId = user.uid;
                    console.log("Firebase authenticated. User ID:", window.userId);
                    // Show the login view now that Firebase Auth is ready
                    document.getElementById('loading-view').dataset.view = 'inactive';
                    document.getElementById('login-view').dataset.view = 'active';
                } else {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            await signInAnonymously(window.auth);
                        }
                    } else {
                        await signInAnonymously(window.auth);
                    }
                }
            });

            // Expose Firestore functions to the global scope
            window.firestore = { doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, addDoc, updateDoc };
        } else {
            console.error("Firebase configuration is missing or invalid. Firestore features will be disabled.");
        }

        // Default Data if no rates are found in Firestore (Includes Child Rate)
        window.DEFAULT_RATES = {
            tickets: [
                { name: "Eiffel Tower Entry", rate: 30.00, childRate: 15.00 },
                { name: "Louvre Museum Pass (Full Day)", rate: 25.00, childRate: 12.50 },
                { name: "Palace of Versailles Tour", rate: 45.00, childRate: 22.50 },
            ],
            transport: [
                { name: "Standard Car (1-3 Pax) - One Way", rate: 80.00, childRate: 0.00 },
                { name: "Minivan (4-6 Pax) - Half Day", rate: 180.00, childRate: 0.00 },
            ]
        };
    </script>
    <!-- End Firebase SDKs -->

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .quote-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .header-bg {
            background-color: #0b5394; /* Darker Blue for Nextgen Tours */
        }
        .text-primary {
            color: #0b5394;
        }
        [data-view="inactive"] { display: none !important; }
        [data-view="active"] { display: flex; } /* Changed to flex for login view centering */
        #main-app-container { display: none; } /* Initially hide main app */
    </style>
</head>
<body>

<!-- 0. LOGIN SCREEN (Now with password protection) -->
<div id="login-view" data-view="inactive" class="min-h-screen items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-xl quote-card p-8 space-y-6">
        <h2 class="text-3xl font-bold text-center text-primary mb-6">Nextgen Tours Login</h2>
        
        <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                <input id="username" type="text" required placeholder="Enter username (e.g., admin or agent)" class="mt-1 block w-full p-3 rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 border" autocomplete="username">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input id="password" type="password" required placeholder="Enter password" class="mt-1 block w-full p-3 rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 border" autocomplete="current-password">
            </div>
            
            <button type="submit" class="w-full flex items-center justify-center p-3 bg-indigo-600 text-white rounded-lg font-semibold text-lg shadow-md hover:bg-indigo-700 transition duration-150">
                <i class="fas fa-sign-in-alt mr-3"></i> Secure Login
            </button>
        </form>
        
        <p id="login-status" class="text-center text-red-500 text-sm"></p>
        <p class="text-xs text-gray-500 text-center mt-4">
            *Demo Credentials: Admin (`admin` / `adminpass`) | Agent (`agent` / `agentpass`)
        </p>
    </div>
</div>

<!-- 0. LOADING SCREEN -->
<div id="loading-view" data-view="active" class="min-h-screen items-center justify-center p-4">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-3"></div>
        <p class="text-lg text-gray-600">Initializing Firebase access...</p>
    </div>
</div>

<!-- MAIN APPLICATION CONTAINER -->
<div id="main-app-container" class="min-h-screen p-4 sm:p-8" style="display: none;">

    <div class="max-w-7xl mx-auto mb-4 p-4 bg-white rounded-xl shadow">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">Nextgen Tours - Quote Manager</h1>
            <div class="flex space-x-2" id="main-nav">
                <button onclick="changeView('dashboard')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150">Dashboard</button>
                <button id="rates-nav-button" onclick="changeView('rates')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150">Manage Rates</button>
                <button onclick="changeView('builder')" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition duration-150">New Query/Quote</button>
                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150">Logout</button>
            </div>
        </div>
    </div>
    
    <!-- 1. DASHBOARD VIEW -->
    <div id="dashboard-view" data-view="active" class="max-w-7xl mx-auto bg-white rounded-xl quote-card overflow-hidden p-6">
        <h2 class="text-2xl font-bold text-primary mb-4 border-b pb-2">Quote Dashboard</h2>
        
        <!-- Dashboard Filtering System -->
        <div class="mb-4 flex items-center space-x-3">
            <input type="text" id="dashboard-search" oninput="filterDashboard()" placeholder="Filter by Guest/Agent Name or Quote Number..." class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            <span class="text-sm text-gray-500">Role: <span id="role-display" class="font-bold text-primary"></span></span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Query No.</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Query Date</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent/Guest</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Arrival/Nights</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pax (A/C)</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quote Amount</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Action</th>
                    </tr>
                </thead>
                <tbody id="dashboard-list" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="7" class="text-gray-500 p-4 text-center">Loading quotations...</td></tr>
                </tbody>
            </table>
        </div>
        
        <p class="mt-4 text-sm text-gray-500">
            <span class="font-semibold">User ID:</span> 
            <span id="user-id-display">N/A</span> 
            (Required for collaborative environment)
        </p>
    </div>

    <!-- 2. RATES MANAGEMENT VIEW -->
    <div id="rates-view" data-view="inactive" class="max-w-5xl mx-auto bg-white rounded-xl quote-card overflow-hidden p-6">
        <h2 class="text-2xl font-bold text-primary mb-6 border-b pb-2">Manage Master Rates</h2>
        
        <div id="rate-access-denied" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Access Denied!</strong>
            <span class="block sm:inline"> Only Admin users can manage and save master rates.</span>
        </div>

        <div id="rate-management-form" class="space-y-6">
            <!-- Tickets Rate Management -->
            <div class="p-4 border rounded-lg">
                <h3 class="text-xl font-semibold mb-3">Attraction Tickets (Adult & Child Rates)</h3>
                 <div class="flex space-x-2 items-center text-xs font-semibold text-gray-600 mb-1 border-b pb-1">
                    <span class="flex-grow">Item Name</span>
                    <span class="w-32 text-right">Adult Rate</span>
                    <span class="w-32 text-right">Child Rate</span>
                    <span class="w-10"></span>
                </div>
                <div id="rates-tickets-container" class="space-y-2">
                    <!-- Dynamic rate inputs -->
                </div>
                <button id="add-ticket-rate-btn" onclick="addRateInput('tickets')" class="mt-3 px-3 py-1 text-sm bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-150">
                    + Add New Ticket Rate
                </button>
            </div>
            
            <!-- Transport Rate Management -->
            <div class="p-4 border rounded-lg">
                <h3 class="text-xl font-semibold mb-3">Transport Services (Rate Only)</h3>
                 <div class="flex space-x-2 items-center text-xs font-semibold text-gray-600 mb-1 border-b pb-1">
                    <span class="flex-grow">Item Name</span>
                    <span class="w-32 text-right">Rate</span>
                    <span class="w-10"></span>
                </div>
                <div id="rates-transport-container" class="space-y-2">
                    <!-- Dynamic rate inputs -->
                </div>
                <button id="add-transport-rate-btn" onclick="addRateInput('transport')" class="mt-3 px-3 py-1 text-sm bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-150">
                    + Add New Transport Rate
                </button>
            </div>

            <button id="save-rates-btn" onclick="saveMasterRates()" class="w-full px-4 py-2 bg-primary text-white rounded-md font-semibold hover:bg-blue-700 transition duration-150">
                Save All Master Rates
            </button>
            <p id="rate-status" class="text-center text-sm text-green-600"></p>
        </div>
    </div>

    <!-- 3. QUOTE BUILDER VIEW -->
    <div id="builder-view" data-view="inactive" class="max-w-7xl mx-auto bg-white rounded-xl quote-card overflow-hidden">

        <!-- Header -->
        <div class="header-bg p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Nextgen Tours</h1>
                <p class="text-sm opacity-80" id="quote-builder-subtitle">Create and Save New Query/Quote</p>
            </div>
            <div class="text-right">
                <p id="quote-number" class="text-lg font-semibold">New Quote</p>
                <p id="quote-date" class="text-sm"></p>
            </div>
        </div>

        <!-- Quote Details & Inputs -->
        <div class="p-6 space-y-6">
            <input type="hidden" id="current-quote-id" value=""> <!-- Hidden field for quote ID -->

            <!-- Client & Quote Info (Expanded) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 border-b pb-4">
                
                <!-- ROW 1: People & Contact -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Agent Name</label>
                    <input id="agent-name" type="text" placeholder="Selling Agent" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Guest Name</label>
                    <input id="client-name" type="text" placeholder="Lead Guest Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Guest Phone</label>
                    <input id="guest-phone" type="tel" placeholder="Phone Number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Hotel Name</label>
                    <input id="hotel-name" type="text" placeholder="Accommodation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                
                <!-- ROW 2: Travel Details -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Arrival Date</label>
                    <input id="arrival-date" type="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Total Nights</label>
                    <input id="total-nights" type="number" min="1" value="7" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Total Adults</label>
                    <input id="total-adults" type="number" min="0" value="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Total Children</label>
                    <input id="total-children" type="number" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                
                <!-- ROW 3: Query Date -->
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700">Query Date (Today)</label>
                    <input id="query-date" type="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

            </div>

            <!-- Table Structure -->
            <div class="space-y-8">
                
                <!-- 1. Attraction Tickets Section -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-primary border-b pb-2">Attraction Tickets</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Adult Qty</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Child Qty</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Base Rate (Adult/Child)</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Markup/Person</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Subtotal</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="tickets-container" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic Rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <button onclick="addLineItem('tickets')" class="w-full sm:w-auto mt-2 px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition duration-150 shadow-md">
                        + Add Ticket Item
                    </button>
                    <div class="text-right pt-2 border-t mt-4">
                        <span class="text-md font-semibold text-gray-800">TICKET SUBTOTAL:</span>
                        <span id="tickets-subtotal" class="text-lg font-bold text-primary ml-2">$0.00</span>
                    </div>
                </div>

                <!-- 2. Transport Services Section -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-primary border-b pb-2">Transport Services</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Units</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Rate (USD)</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Markup/Unit</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Subtotal</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="transport-container" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic Rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <button onclick="addLineItem('transport')" class="w-full sm:w-auto mt-2 px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition duration-150 shadow-md">
                        + Add Transport Item
                    </button>
                    <div class="text-right pt-2 border-t mt-4">
                        <span class="text-md font-semibold text-gray-800">TRANSPORT SUBTOTAL:</span>
                        <span id="transport-subtotal" class="text-lg font-bold text-primary ml-2">$0.00</span>
                    </div>
                </div>

                <!-- 3. Grand Total Summary -->
                <div class="pt-6 border-t-4 border-indigo-500 text-right space-y-2">
                    <div class="text-xl font-bold text-gray-700">
                        <span class="inline-block w-40">TOTAL QUOTE:</span>
                        <span id="grand-total" class="inline-block w-32 text-4xl text-green-600 ml-2">$0.00</span>
                    </div>
                    <p class="text-sm text-gray-500">All prices are inclusive of taxes unless otherwise noted.</p>
                </div>
                
                <button onclick="saveQuotation()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg text-lg font-semibold hover:bg-green-700 transition duration-150 shadow-lg">
                    SAVE & GENERATE QUOTATION
                </button>
                <p id="quote-status" class="text-center text-sm text-green-600"></p>
                
            </div>
        </div>
    </div>
</div>

<script>
    // Global state management
    let currentView = 'dashboard';
    let uniqueIdCounter = 0;
    let masterRates = { tickets: [], transport: [] }; // Holds rates fetched from Firestore
    let allQuotes = []; // Cache for all fetched quotes (for filtering)
    window.userRole = null; // Stores the authenticated user's role

    /** --- Core Application Logic --- */

    /**
     * Handles the login process by checking hardcoded credentials.
     */
    window.handleLogin = function(event) {
        event.preventDefault(); // Prevent form submission
        
        if (!window.userId) {
            document.getElementById('login-status').textContent = "Authentication is still loading. Please wait...";
            return;
        }

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const statusElement = document.getElementById('login-status');
        
        // --- Hardcoded Dummy Credentials ---
        const CREDENTIALS = {
            'admin': 'adminpass',
            'agent': 'agentpass'
        };

        let role = null;
        if (username === 'admin' && password === CREDENTIALS.admin) {
            role = 'admin';
        } else if (username === 'agent' && password === CREDENTIALS.agent) {
            role = 'agent';
        } else {
            statusElement.textContent = "Invalid username or password. Please try again.";
            return;
        }

        // Login successful
        window.userRole = role;
        statusElement.textContent = "Login successful!";
        statusElement.className = "text-center text-sm text-green-600";
        document.getElementById('login-view').dataset.view = 'inactive';
        document.getElementById('main-app-container').style.display = 'block';
        
        // Final initialization after role is set
        window.initApp();
    }

    /**
     * Handles the logout process.
     */
    window.handleLogout = function() {
        window.userRole = null;
        document.getElementById('main-app-container').style.display = 'none';
        document.getElementById('login-view').dataset.view = 'active';
        document.getElementById('login-status').textContent = "Logged out successfully.";
        document.getElementById('login-status').className = "text-center text-red-500 text-sm";
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        // Optionally, force Firebase sign out if needed: window.auth.signOut();
    }

    // Function called after successful Firebase authentication AND role selection
    window.initApp = function() {
        if (!window.userId || !window.db || !window.appId || !window.userRole) {
            console.error("Application not fully initialized. Aborting initApp.");
            return;
        }

        document.getElementById('user-id-display').textContent = window.userId;
        document.getElementById('role-display').textContent = window.userRole.toUpperCase();
        
        // Apply Role-Based Access Control to Navigation
        const ratesNavButton = document.getElementById('rates-nav-button');
        if (window.userRole === 'admin') {
            ratesNavButton.classList.remove('hidden');
        } else {
            ratesNavButton.classList.add('hidden');
        }
        
        setupListeners();
        
        // Set initial date for builder (Query Date = Today)
        const today = new Date().toISOString().substring(0, 10);
        document.getElementById('query-date').value = today;
        document.getElementById('arrival-date').value = today; // Default arrival date to today
        
        // Add initial line items
        if (document.getElementById('tickets-container').children.length === 0) {
            addLineItem('tickets');
        }
        if (document.getElementById('transport-container').children.length === 0) {
            addLineItem('transport');
        }
    };

    /**
     * Sets up real-time listeners for Firestore data.
     */
    function setupListeners() {
        const currentAppId = window.appId;
        const currentUserId = window.userId;

        // 1. Listen for Master Rates updates
        const ratesDocRef = firestore.doc(db, 'artifacts', currentAppId, 'users', currentUserId, 'master_data', 'rates');
        firestore.onSnapshot(ratesDocRef, (docSnap) => {
            if (docSnap.exists()) {
                masterRates = docSnap.data();
                console.log("Master Rates updated from Firestore:", masterRates);
            } else {
                // Only admin can create defaults, but all users read the rates
                masterRates = window.DEFAULT_RATES;
                if (window.userRole === 'admin') {
                    console.log("No master rates found. Saving defaults.");
                    firestore.setDoc(ratesDocRef, masterRates).catch(e => console.error("Error setting default rates:", e));
                }
            }
            renderRateManagement(masterRates);
            repopulateBuilderDropdowns();
        }, (error) => {
            console.error("Error reading master rates:", error);
        });

        // 2. Listen for Quotations updates (Dashboard)
        const quotesCollectionRef = firestore.collection(db, 'artifacts', currentAppId, 'users', currentUserId, 'quotations');
        firestore.onSnapshot(quotesCollectionRef, (snapshot) => {
            allQuotes = [];
            snapshot.forEach(doc => {
                allQuotes.push({ id: doc.id, ...doc.data() });
            });
            // Initial render of dashboard with all quotes
            filterDashboard(); 
        }, (error) => {
            console.error("Error reading quotations:", error);
            document.getElementById('dashboard-list').innerHTML = `<tr><td colspan="7" class="text-red-500 p-4 text-center">Error loading quotes. See console for details.</td></tr>`;
        });
    }
    
    /**
     * Filters the global list of quotes based on the search input.
     */
    window.filterDashboard = function() {
        const searchText = document.getElementById('dashboard-search').value.toLowerCase().trim();
        let filteredQuotes = allQuotes;

        if (searchText) {
            filteredQuotes = allQuotes.filter(quote => {
                const quoteNumber = quote.quoteNumber ? quote.quoteNumber.toLowerCase() : '';
                const clientName = quote.clientName ? quote.clientName.toLowerCase() : '';
                const agentName = quote.agentName ? quote.agentName.toLowerCase() : '';
                
                return quoteNumber.includes(searchText) || 
                       clientName.includes(searchText) || 
                       agentName.includes(searchText);
            });
        }

        renderDashboard(filteredQuotes);
    }

    /**
     * Finds the next sequential quote number (e.g., 1001, 1002...).
     */
    async function getNextQuoteNumber() {
        const quotesCollectionRef = firestore.collection(db, 'artifacts', window.appId, 'users', window.userId, 'quotations');
        
        try {
            const q = firestore.query(quotesCollectionRef);
            const snapshot = await firestore.getDocs(q);
            
            let maxNumber = 1000; // Start series at 1001

            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.quoteNumber) {
                    const num = parseInt(data.quoteNumber, 10);
                    if (!isNaN(num) && num > maxNumber) {
                        maxNumber = num;
                    }
                }
            });
            
            return (maxNumber + 1).toString().padStart(4, '0');

        } catch (e) {
            console.error("Error generating sequential quote number:", e);
            return 'ERR' + Math.floor(Math.random() * 10000); 
        }
    }


    /** --- Rate Management Logic --- */

    /**
     * Renders the Rate Management view inputs and applies RBAC.
     * @param {object} rates - The current master rates object.
     */
    function renderRateManagement(rates) {
        const isAdmin = window.userRole === 'admin';
        const form = document.getElementById('rate-management-form');
        const denied = document.getElementById('rate-access-denied');
        const saveBtn = document.getElementById('save-rates-btn');
        const addTicketBtn = document.getElementById('add-ticket-rate-btn');
        const addTransportBtn = document.getElementById('add-transport-rate-btn');
        
        // RBAC: Enable/Disable editing features
        form.classList.toggle('opacity-50', !isAdmin);
        saveBtn.disabled = !isAdmin;
        addTicketBtn.disabled = !isAdmin;
        addTransportBtn.disabled = !isAdmin;
        denied.classList.toggle('hidden', isAdmin);
        
        // Remove existing inputs
        ['tickets', 'transport'].forEach(category => {
            const container = document.getElementById(`rates-${category}-container`);
            container.innerHTML = '';
        });
        
        // Render inputs
        ['tickets', 'transport'].forEach(category => {
            const container = document.getElementById(`rates-${category}-container`);
            rates[category].forEach((item, index) => {
                const childRate = item.childRate || 0.00; 
                container.appendChild(createRateInput(category, index, item.name, item.rate, childRate, isAdmin));
            });
        });
    }

    /**
     * Creates a single name/rate input row for the Manage Rates view.
     */
    function createRateInput(category, index, name, rate, childRate = 0.00, isAdmin) {
        const div = document.createElement('div');
        div.className = 'flex space-x-2 items-center';
        div.dataset.index = index;
        div.dataset.category = category;

        let childRateInput = '';
        if (category === 'tickets') {
            childRateInput = `
                <input type="number" value="${childRate.toFixed(2)}" placeholder="Child Rate (USD)" data-type="childRate" class="w-32 p-2 border rounded-md text-sm text-right" ${isAdmin ? '' : 'readonly'}>
            `;
        }

        div.innerHTML = `
            <input type="text" value="${name}" placeholder="Item Name" data-type="name" class="flex-grow p-2 border rounded-md text-sm" ${isAdmin ? '' : 'readonly'}>
            <input type="number" value="${rate.toFixed(2)}" placeholder="${category === 'tickets' ? 'Adult Rate (USD)' : 'Rate (USD)'}" data-type="rate" class="w-32 p-2 border rounded-md text-sm text-right" ${isAdmin ? '' : 'readonly'}>
            ${childRateInput}
            <button onclick="removeRateInput(this)" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition duration-150 ${isAdmin ? '' : 'hidden'}" title="Remove Rate">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        `;
        return div;
    }

    /**
     * Adds an empty input row in the Manage Rates view. (Admin Only via button visibility)
     */
    function addRateInput(category) {
        const container = document.getElementById(`rates-${category}-container`);
        container.appendChild(createRateInput(category, container.children.length, '', 0.00, 0.00, true));
    }

    /**
     * Removes a rate input row from the Manage Rates view. (Admin Only via button visibility)
     */
    function removeRateInput(buttonElement) {
        if (window.userRole === 'admin') {
            buttonElement.closest('div').remove();
        }
    }

    /**
     * Reads and saves the rates from the Manage Rates UI back to Firestore.
     */
    async function saveMasterRates() {
        if (window.userRole !== 'admin') {
            document.getElementById('rate-status').textContent = "Operation denied. Requires Admin role.";
            document.getElementById('rate-status').className = "text-center text-sm text-red-600";
            return;
        }
        
        const newRates = { tickets: [], transport: [] };
        const statusElement = document.getElementById('rate-status');
        statusElement.textContent = "Saving...";
        statusElement.className = "text-center text-sm text-blue-600";
        
        ['tickets', 'transport'].forEach(category => {
            const container = document.getElementById(`rates-${category}-container`);
            Array.from(container.children).forEach(row => {
                const name = row.querySelector('[data-type="name"]').value.trim();
                const rate = parseFloat(row.querySelector('[data-type="rate"]').value);
                
                if (name && !isNaN(rate) && rate >= 0) {
                    if (category === 'tickets') {
                        const childRate = parseFloat(row.querySelector('[data-type="childRate"]').value) || 0;
                        newRates[category].push({ 
                            name, 
                            rate: parseFloat(rate.toFixed(2)), 
                            childRate: parseFloat(childRate.toFixed(2)) 
                        });
                    } else {
                        newRates[category].push({ 
                            name, 
                            rate: parseFloat(rate.toFixed(2)) 
                        });
                    }
                }
            });
        });

        masterRates = newRates;
        
        // Save to Firestore
        try {
            const ratesDocRef = firestore.doc(db, 'artifacts', window.appId, 'users', window.userId, 'master_data', 'rates');
            await firestore.setDoc(ratesDocRef, masterRates);
            statusElement.textContent = "Master Rates saved successfully!";
            statusElement.className = "text-center text-sm text-green-600";
            setTimeout(() => statusElement.textContent = '', 3000);
        } catch (e) {
            console.error("Error saving master rates:", e);
            statusElement.textContent = "Error saving rates! Check console.";
            statusElement.className = "text-center text-sm text-red-600";
        }
        
        repopulateBuilderDropdowns();
    }
    
    /** --- Quote Builder Logic --- */

    /**
     * VLOOKUP equivalent function: Gets the rate object based on the item name.
     */
    function getRate(category, itemName) {
        const item = masterRates[category].find(i => i.name === itemName);
        return item ? item : { rate: 0, childRate: 0 }; 
    }

    /**
     * Creates the HTML options for the dropdown menu.
     */
    function createOptionsHTML(category) {
        const items = masterRates[category];
        let options = '<option value="" disabled selected>Select an item</option>';
        items.forEach(item => {
            options += `<option value="${item.name}">${item.name}</option>`;
        });
        return options;
    }
    
    /**
     * Creates the HTML for the dropdown menu based on the category rates.
     */
    function createSelectElement(category, rowId, selectedName = '') {
        return `
            <select
                onchange="updateRate('${category}', '${rowId}')"
                class="w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm p-1 border"
                data-category="${category}"
                data-type="item-name"
            >
                ${createOptionsHTML(category)}
            </select>
        `;
    }

    /**
     * Adds a new dynamic line item row to the specified category table.
     */
    function addLineItem(category, itemData = {}) {
        uniqueIdCounter++;
        const rowId = `${category}-${uniqueIdCounter}`;
        const container = document.getElementById(`${category}-container`);

        const newRow = document.createElement('tr');
        newRow.id = rowId;
        newRow.className = 'hover:bg-gray-50 transition duration-150';
        
        const isTicket = category === 'tickets';
        const defaultAdultQty = itemData.adultQty || 1;
        const defaultChildQty = itemData.childQty || 0;
        const defaultUnits = itemData.qty || 1; // used for transport
        const defaultMarkup = itemData.serviceChargePerPerson || itemData.serviceChargePerUnit || 0.00;
        
        let qtyInputs;
        let baseRateInput;

        if (isTicket) {
            qtyInputs = `
                <td class="px-3 py-2 whitespace-nowrap">
                    <input type="number" min="0" value="${defaultAdultQty}" oninput="calculateRowTotal('tickets', '${rowId}')" data-type="adult-qty" class="w-full text-center rounded-md border-gray-300 p-1 shadow-sm text-sm border">
                </td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <input type="number" min="0" value="${defaultChildQty}" oninput="calculateRowTotal('tickets', '${rowId}')" data-type="child-qty" class="w-full text-center rounded-md border-gray-300 p-1 shadow-sm text-sm border">
                </td>
            `;
            baseRateInput = `
                <input type="text" readonly value="0.00/0.00" data-type="rate-display" class="w-full text-right bg-gray-100 rounded-md p-1 border-transparent text-xs font-medium" title="Adult Rate / Child Rate">
                <input type="hidden" value="0.00" data-type="rate">
                <input type="hidden" value="0.00" data-type="child-rate">
            `;
        } else { // transport
             qtyInputs = `
                <td class="px-3 py-2 whitespace-nowrap">
                    <input type="number" min="1" value="${defaultUnits}" oninput="calculateRowTotal('transport', '${rowId}')" data-type="units" class="w-full text-center rounded-md border-gray-300 p-1 shadow-sm text-sm border">
                </td>
                <td class="hidden"></td>
            `;
            baseRateInput = `
                <input type="text" readonly value="0.00" data-type="rate-display" class="w-full text-right bg-gray-100 rounded-md p-1 border-transparent text-sm font-medium">
                <input type="hidden" value="0.00" data-type="rate">
            `;
        }


        newRow.innerHTML = `
            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                ${createSelectElement(category, rowId)}
            </td>
            ${qtyInputs}
            <td class="px-3 py-2 whitespace-nowrap text-right">
                ${baseRateInput}
            </td>
            <td class="px-3 py-2 whitespace-nowrap">
                 <input
                    type="number"
                    min="0"
                    step="0.01"
                    value="${defaultMarkup.toFixed(2)}"
                    oninput="calculateRowTotal('${category}', '${rowId}')"
                    data-type="markup"
                    class="w-full text-center rounded-md border-gray-300 p-1 shadow-sm text-sm border"
                    title="${isTicket ? 'Service Charge per Person' : 'Service Charge per Unit'}"
                >
            </td>
            <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-bold">
                <span data-type="row-total">0.00</span>
            </td>
            <td class="px-3 py-2 whitespace-nowrap text-right">
                <button onclick="removeLineItem('${rowId}', '${category}')" class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-100 transition duration-150" title="Remove Item">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </td>
        `;
        container.appendChild(newRow);
        
        // If loading existing data, set the dropdown value and run calculation
        if (itemData.name) {
            newRow.querySelector('[data-type="item-name"]').value = itemData.name;
            updateRate(category, rowId);
        }
    }
    
    function removeLineItem(rowId, category) {
        document.getElementById(rowId).remove();
        calculateSubtotal(category);
    }
    
    function updateRate(category, rowId) {
        const row = document.getElementById(rowId);
        const itemName = row.querySelector('[data-type="item-name"]').value;
        const rateDisplayInput = row.querySelector('[data-type="rate-display"]');
        const rateDataInput = row.querySelector('[data-type="rate"]');
        
        const rates = getRate(category, itemName);
        
        if (category === 'tickets') {
            const childRateDataInput = row.querySelector('[data-type="child-rate"]');
            
            rateDisplayInput.value = `${rates.rate.toFixed(2)}/${rates.childRate.toFixed(2)}`;
            rateDataInput.value = rates.rate.toFixed(2);
            childRateDataInput.value = rates.childRate.toFixed(2);
        } else {
            rateDisplayInput.value = rates.rate.toFixed(2);
            rateDataInput.value = rates.rate.toFixed(2);
        }
        
        calculateRowTotal(category, rowId);
    }
    
    /**
     * Calculates the row total including markup for both tickets and transport.
     */
    function calculateRowTotal(category, rowId) {
        const row = document.getElementById(rowId);
        const rate = parseFloat(row.querySelector('[data-type="rate"]').value) || 0;
        const markup = parseFloat(row.querySelector('[data-type="markup"]').value) || 0;
        const totalElement = row.querySelector('[data-type="row-total"]');
        
        let baseCost = 0;
        let markupUnits = 0;

        if (category === 'tickets') {
            const adultQty = parseFloat(row.querySelector('[data-type="adult-qty"]').value) || 0;
            const childQty = parseFloat(row.querySelector('[data-type="child-qty"]').value) || 0;
            const childRate = parseFloat(row.querySelector('[data-type="child-rate"]').value) || 0; 
            
            baseCost = (adultQty * rate) + (childQty * childRate);
            markupUnits = adultQty + childQty; // Markup is per person
        } else { // transport
            const units = parseFloat(row.querySelector('[data-type="units"]').value) || 0;
            
            baseCost = units * rate;
            markupUnits = units; // Markup is per unit/run
        }
        
        const serviceChargeTotal = markupUnits * markup;
        const rowTotal = baseCost + serviceChargeTotal;

        if (totalElement) {
            totalElement.textContent = rowTotal.toFixed(2);
        }
        
        calculateSubtotal(category);
    }

    function calculateSubtotal(category) {
        const container = document.getElementById(`${category}-container`);
        const rows = container.querySelectorAll('tr');
        let subtotal = 0;

        rows.forEach(row => {
            const totalElement = row.querySelector('[data-type="row-total"]');
            if (totalElement) {
                subtotal += parseFloat(totalElement.textContent) || 0;
            }
        });

        document.getElementById(`${category}-subtotal`).textContent = `$${subtotal.toFixed(2)}`;
        calculateGrandTotal();
    }

    function calculateGrandTotal() {
        const ticketsSubtotalText = document.getElementById('tickets-subtotal').textContent.replace('$', '');
        const transportSubtotalText = document.getElementById('transport-subtotal').textContent.replace('$', '');

        const ticketsTotal = parseFloat(ticketsSubtotalText) || 0;
        const transportTotal = parseFloat(transportSubtotalText) || 0;
        
        const grandTotal = ticketsTotal + transportTotal;
        document.getElementById('grand-total').textContent = `$${grandTotal.toFixed(2)}`;
        return grandTotal;
    }

    /**
     * Collects all quote data and saves it to Firestore. (Agent/Admin allowed)
     */
    async function saveQuotation() {
        if (!window.userRole) {
            document.getElementById('quote-status').textContent = "Please log in first to save a quotation.";
            document.getElementById('quote-status').className = "text-center text-sm text-red-600";
            return;
        }
        
        const quoteId = document.getElementById('current-quote-id').value;
        const statusElement = document.getElementById('quote-status');

        const agentName = document.getElementById('agent-name').value.trim();
        const clientName = document.getElementById('client-name').value.trim();
        const guestPhone = document.getElementById('guest-phone').value.trim();
        const arrivalDate = document.getElementById('arrival-date').value;
        const totalNights = parseInt(document.getElementById('total-nights').value) || 0;
        const hotelName = document.getElementById('hotel-name').value.trim();
        const totalAdults = parseInt(document.getElementById('total-adults').value) || 0;
        const totalChildren = parseInt(document.getElementById('total-children').value) || 0;
        const queryDate = document.getElementById('query-date').value;


        if (!clientName || !agentName) {
            statusElement.textContent = "Please enter Agent Name and Guest Name.";
            statusElement.className = "text-center text-sm text-red-600";
            return;
        }

        const items = [];
        const grandTotal = calculateGrandTotal();

        ['tickets', 'transport'].forEach(category => {
            const isTicket = category === 'tickets';
            const container = document.getElementById(`${category}-container`);
            container.querySelectorAll('tr').forEach(row => {
                const itemName = row.querySelector('[data-type="item-name"]').value;
                const rate = parseFloat(row.querySelector('[data-type="rate"]').value);
                const markup = parseFloat(row.querySelector('[data-type="markup"]').value);
                const rowTotal = parseFloat(row.querySelector('[data-type="row-total"]').textContent);

                if (itemName) {
                    const item = {
                        category,
                        name: itemName,
                        rate: rate,
                        serviceChargePerPerson: isTicket ? markup : 0,
                        serviceChargePerUnit: isTicket ? 0 : markup,
                        total: rowTotal
                    };

                    if (isTicket) {
                        item.adultQty = parseFloat(row.querySelector('[data-type="adult-qty"]').value);
                        item.childQty = parseFloat(row.querySelector('[data-type="child-qty"]').value);
                        item.childRate = parseFloat(row.querySelector('[data-type="child-rate"]').value);
                        if (item.adultQty === 0 && item.childQty === 0) return; // Skip if no people selected
                    } else {
                        item.qty = parseFloat(row.querySelector('[data-type="units"]').value);
                        if (item.qty === 0) return; // Skip if no units selected
                    }
                    items.push(item);
                }
            });
        });

        if (items.length === 0) {
            statusElement.textContent = "Please add at least one item to the quote.";
            statusElement.className = "text-center text-sm text-red-600";
            return;
        }

        const quoteData = {
            agentName: agentName,
            clientName: clientName,
            guestPhone: guestPhone,
            arrivalDate: arrivalDate,
            totalNights: totalNights,
            hotelName: hotelName,
            totalAdults: totalAdults,
            totalChildren: totalChildren,
            queryDate: queryDate,
            
            // Financials and line items
            dateUpdated: new Date().toISOString(),
            grandTotal: parseFloat(grandTotal.toFixed(2)),
            ticketSubtotal: parseFloat(document.getElementById('tickets-subtotal').textContent.replace('$', '')),
            transportSubtotal: parseFloat(document.getElementById('transport-subtotal').textContent.replace('$', '')),
            items: items,
            // Track the role that created/last updated the quote (optional but helpful)
            updatedByRole: window.userRole
        };
        
        statusElement.textContent = "Saving quotation...";
        statusElement.className = "text-center text-sm text-blue-600";

        try {
            const quotesCollectionRef = firestore.collection(db, 'artifacts', window.appId, 'users', window.userId, 'quotations');
            
            if (quoteId) {
                await firestore.updateDoc(firestore.doc(quotesCollectionRef, quoteId), quoteData);
                statusElement.textContent = `Quotation ${document.getElementById('quote-number').textContent} updated successfully!`;
            } else {
                quoteData.dateCreated = quoteData.dateUpdated;
                quoteData.quoteNumber = 'Draft';
                const docRef = await firestore.addDoc(quotesCollectionRef, quoteData);
                
                const nextNumber = await getNextQuoteNumber();
                
                await firestore.updateDoc(docRef, { quoteNumber: nextNumber });
                
                document.getElementById('current-quote-id').value = docRef.id;
                document.getElementById('quote-number').textContent = nextNumber;
                statusElement.textContent = `Quotation ${nextNumber} saved successfully!`;
            }

            statusElement.className = "text-center text-sm text-green-600";
            // Switch to dashboard after saving to show the new quote
            setTimeout(() => {
                changeView('dashboard');
                // Ensure the search field is reset when navigating back
                document.getElementById('dashboard-search').value = '';
                filterDashboard(); 
            }, 1500); 
        } catch (e) {
            console.error(quoteId ? "Error updating quotation:" : "Error saving quotation:", e);
            statusElement.textContent = "Error saving quotation! Check console.";
            statusElement.className = "text-center text-sm text-red-600";
        }
    }

    /** --- View Management --- */

    function changeView(newView) {
        // Toggle view containers
        document.getElementById('dashboard-view').dataset.view = 'inactive';
        document.getElementById('rates-view').dataset.view = 'inactive';
        document.getElementById('builder-view').dataset.view = 'inactive';
        document.getElementById(`${newView}-view`).dataset.view = 'active';
        
        currentView = newView;

        // Reset builder fields when starting new quote
        if (newView === 'builder' && document.getElementById('current-quote-id').value === '') {
             resetBuilder();
        }
        
        const subtitle = document.getElementById('quote-builder-subtitle');
        if (subtitle) {
            const action = document.getElementById('current-quote-id').value ? 'Viewing/Editing Existing Quote' : 'Create and Save New Query/Quote';
            subtitle.textContent = action;
        }
    }
    
    function resetBuilder() {
        document.getElementById('current-quote-id').value = '';
        document.getElementById('agent-name').value = '';
        document.getElementById('client-name').value = '';
        document.getElementById('guest-phone').value = '';
        document.getElementById('arrival-date').value = new Date().toISOString().substring(0, 10);
        document.getElementById('total-nights').value = 7;
        document.getElementById('hotel-name').value = '';
        document.getElementById('total-adults').value = 2;
        document.getElementById('total-children').value = 0;
        document.getElementById('query-date').value = new Date().toISOString().substring(0, 10);
        
        document.getElementById('quote-number').textContent = 'New Quote';
        document.getElementById('quote-status').textContent = '';
        document.getElementById('tickets-container').innerHTML = '';
        document.getElementById('transport-container').innerHTML = '';
        document.getElementById('tickets-subtotal').textContent = '$0.00';
        document.getElementById('transport-subtotal').textContent = '$0.00';
        document.getElementById('grand-total').textContent = '$0.00';

        // Add initial row items
        addLineItem('tickets');
        addLineItem('transport');
    }

    /**
     * Renders the list of saved quotations on the dashboard based on the filtered list.
     */
    function renderDashboard(quotes) {
        const list = document.getElementById('dashboard-list');
        list.innerHTML = ''; // Clear existing list

        if (quotes.length === 0) {
            list.innerHTML = `<tr><td colspan="7" class="text-gray-500 p-4 text-center">No quotations match your current filter.</td></tr>`;
            return;
        }

        // Sort by quote number descending 
        quotes.sort((a, b) => {
            const numA = parseInt(a.quoteNumber) || 0;
            const numB = parseInt(b.quoteNumber) || 0;
            return numB - numA;
        });

        quotes.forEach(quote => {
            const queryDate = quote.queryDate ? new Date(quote.queryDate).toLocaleDateString() : 'N/A';
            const arrivalDate = quote.arrivalDate ? new Date(quote.arrivalDate).toLocaleDateString() : 'N/A';
            const pax = `${quote.totalAdults || 0} / ${quote.totalChildren || 0}`;
            
            const item = document.createElement('tr');
            item.className = 'hover:bg-gray-100 transition duration-150 border-b';
            item.innerHTML = `
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-primary">${quote.quoteNumber || 'Draft'}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${queryDate}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm">
                    <span class="font-medium">${quote.agentName || 'N/A'}</span> / ${quote.clientName || 'N/A'}
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${arrivalDate} (${quote.totalNights || 0}N)</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-center">${pax}</td>
                <td class="px-3 py-3 whitespace-nowrap text-right text-base font-bold text-green-600">
                    ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(quote.grandTotal)}
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                     <button onclick="loadQuotation('${quote.id}')" class="text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-2 border rounded-md hover:bg-indigo-50 transition duration-150">EDIT</button>
                </td>
            `;
            list.appendChild(item);
        });
    }

    /**
     * Repopulates dropdowns in the Quote Builder with the latest masterRates.
     */
    function repopulateBuilderDropdowns() {
        const allSelects = document.querySelectorAll('#tickets-container select, #transport-container select');
        allSelects.forEach(select => {
            const category = select.dataset.category;
            const currentName = select.value;
            const rowId = select.closest('tr').id;

            select.innerHTML = createOptionsHTML(category);
            
            // Attempt to re-select the item if it still exists
            if (currentName) {
                const found = masterRates[category].some(item => item.name === currentName);
                if (found) {
                    select.value = currentName;
                } else {
                    select.value = "";
                }
            }
            // Recalculate row if the item changed or was removed
            updateRate(category, rowId);
        });
    }

    /**
     * Fetches and loads a specific quotation into the builder view.
     */
    async function loadQuotation(quoteId) {
        changeView('builder'); // Switch to builder view

        const quotesCollectionRef = firestore.collection(db, 'artifacts', window.appId, 'users', window.userId, 'quotations');
        const quoteDocRef = firestore.doc(quotesCollectionRef, quoteId);

        try {
            const docSnap = await firestore.getDoc(quoteDocRef);
            if (docSnap.exists()) {
                const quote = docSnap.data();
                
                // 1. Reset and Set Quote Info
                document.getElementById('current-quote-id').value = quoteId;
                document.getElementById('agent-name').value = quote.agentName || '';
                document.getElementById('client-name').value = quote.clientName || '';
                document.getElementById('guest-phone').value = quote.guestPhone || '';
                document.getElementById('arrival-date').value = quote.arrivalDate || '';
                document.getElementById('total-nights').value = quote.totalNights || 7;
                document.getElementById('hotel-name').value = quote.hotelName || '';
                document.getElementById('total-adults').value = quote.totalAdults || 2;
                document.getElementById('total-children').value = quote.totalChildren || 0;
                document.getElementById('query-date').value = quote.queryDate || new Date().toISOString().substring(0, 10);
                
                document.getElementById('quote-number').textContent = quote.quoteNumber || 'Draft';
                
                // 2. Clear item containers
                document.getElementById('tickets-container').innerHTML = '';
                document.getElementById('transport-container').innerHTML = '';

                // 3. Populate line items
                quote.items.forEach(item => {
                    let itemData = {
                        name: item.name
                    };

                    if (item.category === 'tickets') {
                        itemData.adultQty = item.adultQty;
                        itemData.childQty = item.childQty;
                        itemData.serviceChargePerPerson = item.serviceChargePerPerson;
                    } else {
                        itemData.qty = item.qty;
                        itemData.serviceChargePerUnit = item.serviceChargePerUnit;
                    }
                    
                    addLineItem(item.category, itemData);
                });
                
                // 4. Final calculation update
                calculateSubtotal('tickets');
                calculateSubtotal('transport');
                
            } else {
                console.error("Quote not found!");
            }
        } catch (error) {
            console.error("Error loading quote:", error);
        }
    }
</script>

</body>
</html>